default_platform(:ios)

platform :ios do
  desc "Build and upload to TestFlight"
  lane :beta do
    # Ensure tools present
    setup_ci

    # Optionally install pods
    cocoapods(clean_install: true)

    # Set build number from CI if provided
    build_number = ENV["BUILD_NUMBER"] || Time.now.strftime("%Y%m%d%H%M")
    app_version = ENV["APP_VERSION"] || "1.0.0"

    # Build IPA via xcodebuild using gym
    gym(
      scheme: "Runner",
      workspace: "Runner.xcworkspace",
      export_method: "app-store",
      export_xcargs: "DEVELOPMENT_TEAM=#{ENV.fetch('DEVELOPER_TEAM_ID', '4JQ6VWVRGY')}",
      build_path: "../build/ios",
      output_directory: "../build/ios/ipa",
      output_name: "Biso_#{app_version}_#{build_number}.ipa",
      include_symbols: true,
      include_bitcode: false,
      silent: false
    )

    # Upload to TestFlight using App Store Connect API key if provided
    if ENV["APPLE_API_KEY_ID"] && ENV["APPLE_API_ISSUER_ID"] && ENV["APPLE_API_PRIVATE_KEY"]
      api_key = app_store_connect_api_key(
        key_id: ENV["APPLE_API_KEY_ID"],
        issuer_id: ENV["APPLE_API_ISSUER_ID"],
        key_content: ENV["APPLE_API_PRIVATE_KEY"],
        is_key_content_base64: false
      )
      pilot(api_key: api_key, skip_waiting_for_build_processing: true)
    else
      # Fallback to Apple ID auth
      pilot(skip_waiting_for_build_processing: true)
    end
  end
end


